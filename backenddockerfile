# 使用 Python 3.9 作为基础镜像
FROM python:3.9-slim

# 设置工作目录
WORKDIR /app

# 设置 Python 环境变量
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    PATH="/app/.local/bin:$PATH" \
    DATABASE_URL="postgresql://postgres:VklXzDrDMygoJNZjzzSlNLMjmqKIPaYQ@postgres.railway.internal:5432/railway"

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    gcc \
    python3-dev \
    libpq-dev \
    curl \
    procps \
    && rm -rf /var/lib/apt/lists/*

# 复制依赖文件
COPY backend/requirements.txt .

# 安装基础 Python 工具
RUN pip install --no-cache-dir --upgrade pip setuptools wheel

# 安装 Python 依赖
RUN pip install --no-cache-dir -r requirements.txt && \
    pip install --no-cache-dir \
    uvicorn[standard] \
    gunicorn \
    fastapi \
    sqlalchemy \
    psycopg2-binary \
    alembic \
    python-dotenv \
    pydantic[email] \
    python-jose[cryptography] \
    passlib[bcrypt] \
    python-multipart \
    aiohttp \
    pandas \
    numpy

# 复制源代码
COPY backend .

# 显示目录结构
RUN echo "Current directory structure:" && \
    ls -la && \
    echo "\nPython path:" && \
    python -c "import sys; print('\n'.join(sys.path))"

# 暴露端口
EXPOSE 8000

# 创建启动脚本
RUN echo '#!/bin/sh\n\
echo "=== Starting application setup ==="\n\
echo "Current working directory: $(pwd)"\n\
echo "Directory contents:"\n\
ls -la\n\
echo "Python version:"\n\
python --version\n\
echo "Installed Python packages:"\n\
pip list\n\
echo "Environment variables:"\n\
env | grep -v "DATABASE_URL"\n\
echo "Starting container with DATABASE_URL=<hidden>"\n\
echo "\n=== Checking database connection ==="\n\
python -c "\
import time\n\
import sys\n\
import os\n\
from sqlalchemy import create_engine\n\
from sqlalchemy.exc import OperationalError\n\
print(f\"Attempting to connect to database...\")\n\
retries = 0\n\
while True:\n\
    try:\n\
        engine = create_engine(os.environ[\"DATABASE_URL\"])\n\
        print(\"Created database engine, attempting connection...\")\n\
        conn = engine.connect()\n\
        print(\"Successfully connected to database\")\n\
        conn.close()\n\
        break\n\
    except OperationalError as e:\n\
        retries += 1\n\
        print(f\"Database connection attempt {retries} failed: {e}\")\n\
        if retries >= 30:  # 1分钟后超时\n\
            print(\"Database connection timeout after 30 attempts\")\n\
            sys.exit(1)\n\
        time.sleep(2)\n\
    except Exception as e:\n\
        print(f\"Unexpected error during database connection: {e}\")\n\
        sys.exit(1)\n\
"\n\
echo "\n=== Running database migrations ==="\n\
alembic upgrade head\n\
echo "\n=== Starting FastAPI application ==="\n\
echo "Starting uvicorn with host=0.0.0.0 port=8000"\n\
exec uvicorn app.main:app --host 0.0.0.0 --port 8000 --log-level debug --timeout-keep-alive 75 --workers 1 --proxy-headers --forwarded-allow-ips "*"\n\
' > /app/start.sh && chmod +x /app/start.sh

# 启动命令
CMD ["/app/start.sh"] 